api.hhofferbot.ru {
    encode zstd gzip

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
    
    @pay path /pay
    handle @pay {
        uri replace /pay /api/v1/pay
        reverse_proxy backend:8000
    }

    @cp path /cp/*               # вебхуки CloudPayments (Check/Pay/Fail)
    handle @cp {
        reverse_proxy backend:8000
    }

    # --- [ADMIN API protected — выше общего API] ---
    @admin_api path /api/v1/admin /api/v1/admin/*
    handle @admin_api {
        basic_auth {
            admin $2b$12$rc6aDGM5pB3PSNMpQbwAKeewHDcT1tU30yN7Jyn.i0jexxMjT2EfK
        }
        reverse_proxy backend:8000
    }

    # API — без обрезания /api
    @api path /api/*
    handle @api {
        reverse_proxy backend:8000
    }

    # --- [ADMIN SPA protected] ---
    # 1) Корень админки (/admin и /admin/) — отдельно, без strip_prefix
    @admin_root path /admin /admin/
    handle @admin_root {
        basic_auth {
            admin $2b$12$rc6aDGM5pB3PSNMpQbwAKeewHDcT1tU30yN7Jyn.i0jexxMjT2EfK
        }
        root * /srv/adminka
        # Явно отдаём index.html, чтобы и GET, и HEAD работали стабильно
        try_files /index.html
        header {
            Cache-Control "no-store, must-revalidate"
            Content-Type "text/html; charset=utf-8"
            -Content-Disposition
        }
        file_server
    }

    # 2) Все вложенные пути админки (/admin/*) — как у вас, со strip_prefix
    @admin_nested path /admin/*
    handle @admin_nested {
        basic_auth {
            admin $2b$12$rc6aDGM5pB3PSNMpQbwAKeewHDcT1tU30yN7Jyn.i0jexxMjT2EfK
        }

        uri strip_prefix /admin
        root * /srv/adminka

        # 1) Статика: отдаём как есть (файлы с расширениями)
        @static path_regexp static \.(?:css|js|png|jpg|jpeg|gif|svg|ico|map|json|wasm|woff2?|ttf)$
        handle @static {
            file_server
        }

        # 2) [Опционально] Whitelist автономных HTML (если реально нужны)
        # @html_pages path_regexp html ^/(?:help|privacy|terms)\.html$
        # handle @html_pages {
        #     file_server
        # }

        # 3) SPA-фолбэк: всё остальное -> index.html
        handle {
            try_files /index.html
            header {
                Cache-Control "no-store, must-revalidate"
                Content-Type "text/html; charset=utf-8"
                -Content-Disposition
            }
            file_server
        }
    }

    # Статика на случай ссылок без /admin/ (оставляем как было)
    @static path /styles.css /script.js /api-bridge.js /user-profile.js
    handle @static {
        root * /srv/adminka
        file_server
    }

    # Корень — редирект в админку
    handle / {
        redir /admin 302
    }

    respond 404
}
